# Tokens and Security

## Token Types

### Access Token

#### Purpose
- **Authorization** for API access
- Proves client has permission to access resources
- Should be treated as **opaque** by client (don't parse)
- Short-lived for security

#### Format
- Can be **JWT** or **opaque string**
- In Auth0, typically JWT when calling your own APIs
- Contains scopes/permissions

#### Contents (when JWT)
- `iss` - Issuer (Auth0 tenant)
- `sub` - Subject (user ID)
- `aud` - Audience (API identifier)
- `exp` - Expiration timestamp
- `iat` - Issued at timestamp
- `scope` - Granted permissions
- Custom claims (namespaced)

#### Lifetime
- Default: Typically 24 hours
- Configurable per API in Auth0
- Balance: Shorter = more secure, Longer = fewer token requests
- Cannot be revoked (expires naturally)

#### Usage
```
Authorization: Bearer <access_token>
```
- Sent in HTTP header to API
- API validates signature and claims
- API checks scopes before granting access

### ID Token

#### Purpose
- **Authentication** - proves user identity
- Contains user information (claims)
- For the **client application**, not APIs
- Result of OpenID Connect authentication

#### Format
- Always **JWT** (JSON Web Token)
- Three parts: Header.Payload.Signature
- Base64-encoded, signed

#### Contents
- **Standard Claims**:
  - `sub` - Subject (unique user ID)
  - `name` - Full name
  - `email` - Email address
  - `email_verified` - Email verification status
  - `picture` - Profile picture URL
  - `nickname` - Display name
  - `updated_at` - Last profile update
  
- **Token Claims**:
  - `iss` - Issuer (Auth0 tenant URL)
  - `aud` - Audience (your client ID)
  - `exp` - Expiration time
  - `iat` - Issued at time
  - `nonce` - Replay attack prevention

#### Lifetime
- Short-lived: Default 36000 seconds (10 hours)
- Configurable in Auth0 tenant settings
- Should not be renewed (get new one via silent auth)

#### Usage
- Used by client to display user info
- **Never send to APIs** (use access token)
- Validate signature before trusting
- Check `aud`, `iss`, `exp` claims

### Refresh Token

#### Purpose
- Obtain new access tokens without re-authentication
- Long-lived credential
- Optional (must be requested)

#### Characteristics
- **Opaque string** (not JWT)
- Stored securely by client
- Can be **revoked** (unlike access tokens)
- Single use or reusable (configurable)

#### Requesting Refresh Token
- Include `offline_access` scope in authorization request
- Only available for certain flows:
  - ✅ Authorization Code Flow
  - ✅ Authorization Code + PKCE
  - ❌ NOT Client Credentials
  - ❌ NOT Implicit

#### Rotation
- **Refresh Token Rotation**: Each use issues new refresh token
- Old token invalidated immediately
- Detects token theft (if old token reused)
- Configurable in Auth0 (on/off)

#### Security Best Practices
- Store securely (never in localStorage for web apps)
- Use rotation
- Set expiration
- Implement detection of reuse

### Token Comparison

| Token Type | Purpose | Format | Lifetime | Sent To |
|------------|---------|--------|----------|---------|
| Access Token | API authorization | JWT or opaque | Short (hours) | Resource Server (API) |
| ID Token | User authentication | JWT | Short (hours) | Client application |
| Refresh Token | Renew access tokens | Opaque | Long (days/months) | Authorization server |

## Client ID and Client Secret

### Client ID

#### What is it?
- **Public identifier** for your application
- Unique per Auth0 application
- Safe to expose in frontend code
- Used in authorization requests

#### Format
- Random string (e.g., `abc123xyz456`)
- Generated by Auth0 when creating application

#### Usage
- Included in authorization URLs
- Identifies which application is making request
- Used in token validation (`aud` claim)

### Client Secret

#### What is it?
- **Secret credential** for your application
- Like a password for your app
- Must be kept **confidential**

#### When Used
- **Confidential clients** only:
  - Server-side web apps
  - Machine-to-machine applications
  - Backend services
  
- **Never use in**:
  - ❌ Single Page Applications (SPAs)
  - ❌ Mobile apps
  - ❌ Native desktop apps
  - ❌ Any public client

#### Purpose
- Authenticate client to authorization server
- Exchange authorization code for tokens
- Request tokens in Client Credentials flow

### Application Types

#### Confidential Clients
- **Can securely store** client secret
- Examples: Traditional web apps, M2M services
- Use Client ID + Client Secret

#### Public Clients
- **Cannot securely store** secrets (code can be decompiled/inspected)
- Examples: SPAs, mobile apps, desktop apps
- Use Client ID + PKCE
- No client secret

## Token Security Best Practices

### Access Tokens
✅ Short expiration times  
✅ Use HTTPS only  
✅ Validate signature and claims  
✅ Check audience and scopes  
✅ Don't store in localStorage (XSS risk)  
✅ Use httpOnly cookies or memory storage  

### ID Tokens
✅ Validate signature  
✅ Verify `iss`, `aud`, `exp`, `nonce`  
✅ Use for user info only, not API calls  
✅ Don't trust claims without validation  

### Refresh Tokens
✅ Enable rotation  
✅ Store securely (never in localStorage)  
✅ Use absolute expiration  
✅ Implement reuse detection  
✅ Revoke on logout  
✅ Consider inactivity expiration  

### General
✅ Use HTTPS everywhere  
✅ Implement CORS properly  
✅ Use state parameter (CSRF protection)  
✅ Use nonce for replay protection  
✅ Log security events  
✅ Monitor for anomalies  

## Token Validation

### Access Token Validation (API Side)

1. **Verify signature**
   - Use JWKS from Auth0
   - Validate cryptographic signature

2. **Validate claims**
   - `iss` - Correct Auth0 tenant
   - `aud` - Your API identifier
   - `exp` - Not expired
   - `scope` - Contains required permissions

3. **Check scopes**
   - Parse scope claim
   - Verify required scope present
   - Deny access if missing

### ID Token Validation (Client Side)

1. **Verify signature** using JWKS

2. **Validate claims**
   - `iss` - Your Auth0 tenant
   - `aud` - Your client ID
   - `exp` - Not expired
   - `nonce` - Matches request (if used)

3. **Extract user info**
   - Parse claims after validation
   - Use for UI personalization

## Token Storage

### Web Applications (SPAs)

**Memory (Best)**
- ✅ Store in JavaScript variable
- ✅ Lost on page refresh (re-authenticate)
- ✅ Not vulnerable to XSS if done right
- ❌ UX: frequent re-auth

**sessionStorage**
- ✅ Cleared on tab close
- ⚠️ Vulnerable to XSS
- Use for ID tokens only

**localStorage**
- ❌ Never use for tokens
- Vulnerable to XSS
- Persists across sessions

**httpOnly Cookies (Best for SPAs with backend)**
- ✅ Not accessible to JavaScript
- ✅ Automatic inclusion in requests
- ✅ CSRF protection needed (SameSite)
- Best security posture

### Mobile/Native Applications
- Use secure storage:
  - iOS: Keychain
  - Android: Keystore
- Never store in plain text
- Use biometric protection when available

### Server-side Applications
- Session storage on server
- Encrypted at rest
- Never log tokens

## Key Exam Takeaways

✅ **Access Token** = API authorization, can be JWT or opaque  
✅ **ID Token** = User authentication, always JWT, for client only  
✅ **Refresh Token** = Get new access tokens, opaque, can be revoked  
✅ **Client ID** = Public identifier, safe to expose  
✅ **Client Secret** = Confidential, only for server-side apps  
✅ **Public clients** (SPAs, mobile) = No secret, use PKCE  
✅ **Confidential clients** (web apps, M2M) = Can use client secret  
✅ **Refresh token rotation** prevents token theft detection  
✅ **offline_access scope** required for refresh tokens  
✅ **Never use localStorage** for tokens in SPAs (XSS risk)  
✅ **Validate signature, iss, aud, exp** on all tokens  
✅ **Access token scopes** checked by API before granting access  
